<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMS Terminal</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1e1e1e;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100vh;
            border: none;
        }
    </style>
</head>
<body>
    <iframe id="terminal-frame" src="/tools/terminal/"></iframe>
    <script>
        // Get path from URL query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const projectPath = urlParams.get('cd');

        if (projectPath) {
            const decodedPath = decodeURIComponent(projectPath.replace(/%2F/g, '/'));

            // Wait for iframe to load, then inject cd command
            const iframe = document.getElementById('terminal-frame');
            let attempts = 0;
            const maxAttempts = 10;

            function injectCdCommand() {
                attempts++;
                try {
                    const iframeWindow = iframe.contentWindow;
                    if (!iframeWindow || !iframeWindow.document) {
                        if (attempts < maxAttempts) {
                            setTimeout(injectCdCommand, 500);
                        }
                        return;
                    }

                    // Try to access ttyd's terminal
                    // ttyd uses xterm.js, we need to find the terminal instance
                    const xterm = iframeWindow.terminal || iframeWindow.ttyd?.terminal;

                    if (xterm && xterm.readyState !== undefined) {
                        // Terminal is ready, send cd command
                        const cdCommand = `cd "${decodedPath}"\r\n`;
                        xterm.send(cdCommand);
                        console.log('CD command sent:', decodedPath);
                    } else {
                        // Try alternative method - find WebSocket
                        const ws = iframeWindow.ws || iframeWindow.socket;
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            const cdCommand = `cd "${decodedPath}"\r\n`;
                            ws.send(cdCommand);
                            console.log('CD command sent via WebSocket:', decodedPath);
                        } else {
                            // Keep trying
                            if (attempts < maxAttempts) {
                                setTimeout(injectCdCommand, 500);
                            } else {
                                // Fallback: show instruction
                                console.warn('Could not inject cd command automatically. Please run: cd "' + decodedPath + '"');
                            }
                        }
                    }
                } catch (e) {
                    // Cross-origin or other error
                    if (attempts < maxAttempts) {
                        setTimeout(injectCdCommand, 500);
                    } else {
                        console.error('Error injecting cd command:', e);
                        alert(`Please run: cd "${decodedPath}"`);
                    }
                }
            }

            iframe.onload = function() {
                setTimeout(injectCdCommand, 1000);
            };

            // Also try immediately in case iframe is already loaded
            if (iframe.contentWindow && iframe.contentWindow.document) {
                setTimeout(injectCdCommand, 1000);
            }
        }
    </script>
</body>
</html>
